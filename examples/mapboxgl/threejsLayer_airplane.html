<!--********************************************************************
* CopyrightÂ© 2000 - 2020 ekmap Software Co.Ltd. All rights reserved.
*********************************************************************-->
<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <script src='https://api.mapbox.com/mapbox-gl-js/v1.11.1/mapbox-gl.js'></script>
    <link href='https://api.mapbox.com/mapbox-gl-js/v1.11.1/mapbox-gl.css' rel='stylesheet' />
    <script type="text/javascript" include="three,GLTFLoader" src="../js/include-web.js"></script>
    <script src="../../dist/mapboxgl/ekmap-mapboxgl.js"></script>
    <script type="text/javascript" src="./js/ThreeApplication.js"></script>
    <script src="../../examples/js/common.js"></script>
    <style>
        html, body {
            margin: 0;
            padding: 0;
            height: 100%;
            width: 100%;
            position: relative;
        }

        #map {
            width: 100%;
            height: 100%;
        }

    </style>
</head>
<body>
<div id="map"></div>
<script>
    var map, threeLayer,
        position = [104.0688174135384, 30.548051075500908];

    map = new mapboxgl.Map({
        container: 'map',
        style: {
                "version": 8,
                "sources": {
                    "raster-tiles": {
                        "type": "raster",
                        "tiles": urlOSMStandard,
                        "tileSize": 256
                    }
                },
                "layers": [
                    {
                        "id": "raster-tiles",
                        "type": "raster",
                        "source": "raster-tiles",
                        "minzoom": 0,
                        "maxzoom": 22,
                        'layout': {
                            'visibility': 'visible',
                        },
                        'raster-opacity': 0.75,
                    }
                ]
            },
        center: [104.0693966828, 30.5760411152],
        zoom: 13.23,
        // bearing: 0.8568,
        // pitch: 60,
        bearing: 50,
        pitch: 100,

    });
    map.addControl(new mapboxgl.NavigationControl(), 'top-left');

    loaderModels();


    function loaderModels() {
        var loader = new THREE.GLTFLoader();
        loader.load('../mapboxgl/js/airplane/airplane.glb', function (gltf) {
            var scene = gltf.scene;
            scene.rotation.x = -Math.PI / 2;
            scene.rotation.y = Math.PI / 2;
            scene.scale.multiplyScalar(150);

            addThreeLayer(scene);
        });
    }

    function addThreeLayer(meshes) {
        threeLayer = new mapboxgl.ekmap.ThreeLayer('three');
        threeLayer.on("initialized", render);
        threeLayer.addTo(map);

        function render() {
            var renderer = threeLayer.getThreeRenderer(),
                scene = threeLayer.getScene(),
                camera = threeLayer.getCamera();

            this.light = new THREE.PointLight(0xaa, 50);
            this.light.position.copy(camera.position);
            scene.add(this.light);
            scene.add(new THREE.AmbientLight(0xffffff));
            threeLayer.setPosition(meshes, position);
            meshes.translateY(5000);
            scene.add(meshes);

            (function animate() {
                requestAnimationFrame(animate);
                meshes.position.y -= 60;
                var center = map.getCenter().toArray();
                center[1] += 0.00008;
                map.setCenter(center);
                renderer.render(scene, camera);
            })()
        }

        threeLayer.on("render", function () {
            threeLayer.light.position.copy(threeLayer.renderer.camera.position);
        });
    }

</script>
</body>
</html>